name: "dbt dev pipeline"

on:
  # push:
  workflow_dispatch:

env:
  ENV_CODE: ${{ vars.ENV_CODE }}
  PROJ_CODE: ${{ vars.PROJ_CODE }}
  BQ_ACCOUNT: ${{ secrets.BQ_ACCOUNT }}
  BQ_PWD: ${{ secrets.BQ_PWD }}

jobs:
  build:
    runs-on: ubuntu-latest
    environment: dev
    
    steps:
      - name: "Step 01 - Checkout current branch"
        id: step-01
        uses: actions/checkout@v3
      - name: "Step 02 - Install gcloud CLI"
        id: step-02a
        run: |
          echo "deb https://packages.cloud.google.com/apt cloud-sdk main" | sudo tee -a /etc/apt/sources.list.d/google-cloud-sdk.list
          curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key --keyring /usr/share/keyrings/cloud.google.gpg add -
          sudo apt-get update && sudo apt-get install google-cloud-cli
      - name: "Step 02 - Install dbt"
        id: step-02
        run: pip3 install dbt-core dbt-bigquery
      - name: "Step 03 - Verify dbt"
        id: step-03
        run: dbt --version
      - name: "Step 04 - Compile dbt"
        id: step-04
        working-directory: ./
        run: |
          ls -ltra
          export DBT_PROFILES_DIR=$PWD
          dbt deps
          dbt debug -t $ENV_CODE
          dbt compile -t $ENV_CODE
